name: Build FFmpeg Desktop

on:
  workflow_dispatch:
    inputs:
      ffmpeg-version:
        description: "FFmpeg release tag (e.g. n7.0.2)"
        required: false
        default: "n7.1"
      publish-release:
        description: "Publish GitHub release?"
        type: boolean
        default: false
        required: true
  push:
    tags:
      - "ffmpeg-*"

env:
  FFMPEG_VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.ffmpeg-version || (startsWith(github.ref, 'refs/tags/') && github.ref_name) || 'n7.1' }}
  FFMPEG_SOURCE_URL: https://github.com/FFmpeg/FFmpeg
  MSYS2_PATH_TYPE: inherit

jobs:
  desktop:
    name: Build desktop for ${{ matrix.artifact_suffix }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact_suffix: linux-x86_64
          - os: macos-13
            artifact_suffix: macos-x86_64
            mac_arch: x86_64
          - os: macos-14
            artifact_suffix: macos-arm64
            mac_arch: arm64
          - os: windows-latest
            artifact_suffix: windows-mingw-x86_64
            windows_toolchain: mingw
          - os: windows-latest
            artifact_suffix: windows-msvc-x86_64
            windows_toolchain: msvc
            msvc_arch: amd64
            msvc_vcvars_target: amd64
          - os: windows-latest
            artifact_suffix: windows-msvc-arm64
            windows_toolchain: msvc
            msvc_arch: arm64
            msvc_vcvars_target: amd64_arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === 公共 artifacts 目录 ===
      - name: Prepare artifact directory (POSIX)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          : "${FFMPEG_VERSION:?FFMPEG_VERSION not set}"
          mkdir -p "$GITHUB_WORKSPACE/artifacts"

      - name: Prepare artifact directory (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:FFMPEG_VERSION) {
            throw 'FFMPEG_VERSION not set'
          }
          $artifactPath = Join-Path $env:GITHUB_WORKSPACE 'artifacts'
          if (-not (Test-Path $artifactPath)) {
            New-Item -Path $artifactPath -ItemType Directory | Out-Null
          }

      # === Linux 依赖 ===
      - name: Install build dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            cmake \
            git \
            libtool \
            pkg-config \
            texinfo \
            zlib1g-dev \
            libssl-dev \
            nasm \
            yasm \
            libxml2-dev

      # === macOS 依赖 ===
      - name: Install build dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          brew update
          brew install automake pkg-config nasm yasm cmake libxml2
          export PKG_CONFIG_PATH="$(brew --prefix libxml2)/lib/pkgconfig:${PKG_CONFIG_PATH:-}"

      # === Windows MinGW 工具链 ===
      - name: Set up MSYS2 toolchain (Windows MinGW)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'mingw'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-ca-certificates
            mingw-w64-x86_64-libxml2

      # === Windows MSVC 工具链（MSYS2 环境，仅用于 make 等） ===
      - name: Set up MSYS2 environment (Windows MSVC)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'msvc'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            diffutils
            make
            zip
            pkgconf
            yasm
            nasm
            libtool
            bison
            automake
            autoconf

      - name: Clean MSYS2 link and prefix (Windows MSVC)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'msvc'
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          if which link >/dev/null 2>&1; then
            rm "$(which link)"
          fi
          rm -rf /usr/local

      # === Linux 构建 ===
      - name: Build FFmpeg (Linux x86_64)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail
          bash ./scripts/linux/linux-x86_64.sh

      # === macOS x86_64 构建 ===
      - name: Build FFmpeg (macOS x86_64)
        if: matrix.os == 'macos-13'
        shell: bash
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail
          bash ./scripts/macos/macos-x86_64.sh

      # === macOS arm64 构建 ===
      - name: Build FFmpeg (macOS arm64)
        if: matrix.os == 'macos-14'
        shell: bash
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail
          bash ./scripts/macos/macos-arm64.sh

      # === Windows MinGW 构建 ===
      - name: Build FFmpeg (Windows MinGW)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'mingw'
        shell: msys2 {0}
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail
          bash ./scripts/windows/windows-mingw-x86_64.sh

      # === Windows MSVC 构建（使用 msvc/build.sh） ===
      - name: Build FFmpeg (Windows MSVC)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'msvc'
        shell: cmd
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
          MSVC_ARCH: ${{ matrix.msvc_arch }}
          MSVC_VCVARS_TARGET: ${{ matrix.msvc_vcvars_target }}
        run: |
          CALL "%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath > vswhere_path.txt
          SET /P VS_PATH=<vswhere_path.txt
          IF "%VS_PATH%"=="" (
            ECHO vcvarsall.bat not found
            EXIT /B 1
          )
          CALL "%VS_PATH%\VC\Auxiliary\Build\vcvarsall.bat" %MSVC_VCVARS_TARGET%
          msys2 -c "./scripts/windows/msvc/build.sh %MSVC_ARCH% shared gpl"

      # === 上传 artifacts ===
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ env.FFMPEG_VERSION }}-${{ matrix.artifact_suffix }}
          path: artifacts/ffmpeg-*-${{ matrix.artifact_suffix }}.tar.gz

  # === 发布 Release ===
  release:
    name: Publish release
    runs-on: ubuntu-latest
    needs: desktop
    permissions:
      contents: write
    if: >
      (github.event_name == 'workflow_dispatch' && inputs.publish-release) ||
      startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          RESOLVED_VERSION="${FFMPEG_VERSION}"
          if [[ "${RESOLVED_VERSION}" == "latest" ]]; then
            latest_url=$(curl -Ls -o /dev/null -w '%{url_effective}' https://github.com/FFmpeg/FFmpeg/releases/latest)
            RESOLVED_VERSION="${latest_url##*/}"
          fi

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            TAG_NAME="ffmpeg-${RESOLVED_VERSION}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          RELEASE_NAME="FFmpeg ${RESOLVED_VERSION}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: false
          prerelease: false
          files: release-artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
