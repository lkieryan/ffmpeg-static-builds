name: Build FFmpeg Desktop

on:
  workflow_dispatch:
    inputs:
      ffmpeg-version:
        description: "FFmpeg release tag (e.g. n7.0.2)"
        required: false
        default: "n7.0.2"
      publish-release:
        description: "Publish GitHub release?"
        type: boolean
        default: false
        required: true
  push:
    tags:
      - "ffmpeg-*"

env:
  FFMPEG_VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.ffmpeg-version || (startsWith(github.ref, 'refs/tags/') && github.ref_name) || 'n7.0.2' }}
  FFMPEG_SOURCE_URL: https://github.com/FFmpeg/FFmpeg

jobs:
  desktop:
    name: Build desktop for ${{ matrix.artifact_suffix }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux-x86_64
          - os: macos-13
            artifact_suffix: macos-x86_64
            mac_arch: x86_64
          - os: macos-14
            artifact_suffix: macos-arm64
            mac_arch: arm64
          - os: windows-latest
            artifact_suffix: windows-mingw-x86_64
            windows_toolchain: mingw
          - os: windows-latest
            artifact_suffix: windows-msvc-x86_64
            windows_toolchain: msvc

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------- 公共 artifacts 目录 --------------------
      - name: Prepare artifact directory (POSIX)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          : "${FFMPEG_VERSION:?FFMPEG_VERSION not set}"
          mkdir -p "$GITHUB_WORKSPACE/artifacts"

      - name: Prepare artifact directory (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not $env:FFMPEG_VERSION) {
            throw 'FFMPEG_VERSION not set'
          }
          $artifactPath = Join-Path $env:GITHUB_WORKSPACE 'artifacts'
          if (-not (Test-Path $artifactPath)) {
            New-Item -Path $artifactPath -ItemType Directory | Out-Null
          }

      # -------------------- Linux 依赖 --------------------
      - name: Install build dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            cmake \
            git \
            libtool \
            pkg-config \
            texinfo \
            zlib1g-dev \
            libssl-dev \
            nasm \
            yasm \
            libxml2-dev

      # -------------------- macOS 依赖 --------------------
      - name: Install build dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          brew update
          brew install automake pkg-config nasm yasm cmake libxml2
          # 某些环境 pkg-config 找不到 libxml2，这里强制加一手
          if ! pkg-config --exists libxml-2.0; then
            export PKG_CONFIG_PATH="$(brew --prefix libxml2)/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          fi

      # -------------------- Windows MinGW 工具链 --------------------
      - name: Set up MSYS2 toolchain (Windows MinGW)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'mingw'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-ca-certificates
            mingw-w64-x86_64-libxml2

      # -------------------- Windows MSVC 依赖 (vcpkg) --------------------
      - name: Install build dependencies (Windows MSVC)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'msvc'
        shell: pwsh
        run: |
          choco install -y nasm yasm ninja make --no-progress

          if (-not (Test-Path "$env:GITHUB_WORKSPACE\\vcpkg")) {
            git clone https://github.com/microsoft/vcpkg "$env:GITHUB_WORKSPACE\\vcpkg"
          }

          & "$env:GITHUB_WORKSPACE\\vcpkg\\bootstrap-vcpkg.bat" -disableMetrics

          # 这里装动态/静态 zlib + openssl + pkgconf
          & "$env:GITHUB_WORKSPACE\\vcpkg\\vcpkg.exe" install `
            zlib:x64-windows `
            zlib:x64-windows-static `
            openssl:x64-windows `
            openssl:x64-windows-static `
            pkgconf:x64-windows `
            libxml2:x64-windows

      # -------------------- Linux / macOS 构建 --------------------
      - name: Build FFmpeg (Linux / macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"

          curl -L "$FFMPEG_SOURCE_URL/archive/refs/tags/${FFMPEG_VERSION}.tar.gz" -o ffmpeg.tar.gz
          tar -xf ffmpeg.tar.gz
          SRC_DIR="FFmpeg-${FFMPEG_VERSION}"
          if [[ ! -d "$SRC_DIR" ]]; then
            SRC_DIR=$(tar -tf ffmpeg.tar.gz | head -1 | cut -d/ -f1)
          fi
          cd "$SRC_DIR"

          PREFIX="$GITHUB_WORKSPACE/build"
          rm -rf "$PREFIX"
          mkdir -p "$PREFIX"

          JOBS=$(sysctl -n hw.ncpu 2>/dev/null || nproc)

          CONFIG_ARGS=(
            --prefix="$PREFIX"
            --enable-shared
            --disable-static
            --enable-gpl
            --enable-version3
            --disable-debug
            --disable-doc
            --disable-ffplay
            --disable-ffprobe
            --enable-demuxer=dash
            --enable-muxer=dash
            --enable-protocol=http
            --enable-protocol=https
            --enable-libxml2
          )

          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            CONFIG_ARGS+=(--enable-pic --enable-openssl)
          else
            # macOS 架构设置
            if [[ "${{ matrix.mac_arch }}" == "x86_64" ]]; then
              export CFLAGS="-arch x86_64 -mmacosx-version-min=11.0"
              export LDFLAGS="-arch x86_64 -mmacosx-version-min=11.0"
              CONFIG_ARGS+=(--arch=x86_64 --target-os=darwin)
            else
              export CFLAGS="-arch arm64 -mmacosx-version-min=11.0"
              export LDFLAGS="-arch arm64 -mmacosx-version-min=11.0"
              CONFIG_ARGS+=(--arch=arm64 --target-os=darwin)
            fi
          fi

          ./configure "${CONFIG_ARGS[@]}"
          make -j"$JOBS"
          make install

          PACKAGE_NAME="ffmpeg-${FFMPEG_VERSION}-${ARTIFACT_SUFFIX}.tar.gz"
          cd "$GITHUB_WORKSPACE"
          mkdir -p artifacts
          tar -czf "artifacts/$PACKAGE_NAME" -C build .

      # -------------------- Windows MinGW 构建 --------------------
      - name: Build FFmpeg (Windows MinGW)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'mingw'
        shell: msys2 {0}
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          set -euxo pipefail

          export MINGW_PREFIX=/mingw64
          export PATH="$MINGW_PREFIX/bin:$PATH"

          # dlltool 在 binutils 里，确保能找到
          command -v x86_64-w64-mingw32-dlltool || ls -l $MINGW_PREFIX/bin

          export PKG_CONFIG_PATH="$MINGW_PREFIX/lib/pkgconfig"
          export PKG_CONFIG="$MINGW_PREFIX/bin/pkg-config"

          cd "$GITHUB_WORKSPACE"
          curl -L "$FFMPEG_SOURCE_URL/archive/refs/tags/${FFMPEG_VERSION}.tar.gz" -o ffmpeg.tar.gz
          tar -xf ffmpeg.tar.gz
          SRC_DIR="FFmpeg-${FFMPEG_VERSION}"
          if [[ ! -d "$SRC_DIR" ]]; then
            SRC_DIR=$(tar -tf ffmpeg.tar.gz | head -1 | cut -d/ -f1)
          fi
          cd "$SRC_DIR"

          PREFIX="$GITHUB_WORKSPACE/build"
          rm -rf "$PREFIX"
          mkdir -p "$PREFIX"

          CC="$MINGW_PREFIX/bin/x86_64-w64-mingw32-gcc"
          CXX="$MINGW_PREFIX/bin/x86_64-w64-mingw32-g++"

          CC="$CC" CXX="$CXX" \
          ./configure \
            --prefix="$PREFIX" \
            --target-os=mingw32 \
            --arch=x86_64 \
            --enable-cross-compile \
            --cross-prefix=x86_64-w64-mingw32- \
            --pkg-config=x86_64-w64-mingw32-pkg-config \
            --disable-debug \
            --disable-doc \
            --disable-ffplay \
            --disable-ffprobe \
            --enable-demuxer=dash \
            --enable-muxer=dash \
            --enable-protocol=http \
            --enable-protocol=https \
            --enable-openssl \
            --enable-libxml2 \
            --enable-shared \
            --disable-static \
            --enable-gpl \
            --enable-version3 \
            --extra-libs="-lssl -lcrypto -lws2_32 -lgdi32 -lz -lcrypt32 -lbcrypt"

          make -j"$(nproc)"
          make install

          PACKAGE_NAME="ffmpeg-${FFMPEG_VERSION}-${ARTIFACT_SUFFIX}.tar.gz"
          cd "$GITHUB_WORKSPACE"
          mkdir -p artifacts
          tar -czf "artifacts/$PACKAGE_NAME" -C build .

      # -------------------- Windows MSVC 构建（关键：移除 msvc-ar 脚本） --------------------
      - name: Build FFmpeg (Windows MSVC)
        if: matrix.os == 'windows-latest' && matrix.windows_toolchain == 'msvc'
        shell: pwsh
        env:
          ARTIFACT_SUFFIX: ${{ matrix.artifact_suffix }}
        run: |
          # 1. 找到 vcvars64.bat
          $programFilesX86 = [Environment]::GetEnvironmentVariable('ProgramFiles(x86)')
          $vcvars = $null
          if ($programFilesX86) {
            $vswhereCandidate = Join-Path $programFilesX86 'Microsoft Visual Studio\Installer\vswhere.exe'
            if (Test-Path $vswhereCandidate) {
              $vcvars = & $vswhereCandidate -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -find "**\vcvars64.bat" | Select-Object -First 1
            }
          }

          if (-not $vcvars) {
            $vcvarsCandidates = @(
              "$env:ProgramFiles\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles(x86)\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles(x86)\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles(x86)\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat",
              "$env:ProgramFiles(x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
            )
            $vcvars = $vcvarsCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          }

          if (-not $vcvars) {
            throw 'vcvars64.bat not found'
          }

          # 2. 找 Git Bash
          $bash = Join-Path $env:ProgramFiles 'Git\bin\bash.exe'
          if (-not (Test-Path $bash)) {
            throw 'Git Bash not found (need Git for Windows)'
          }

          # 3. 写一个 msvc-build.sh（跑在 Git Bash 下）
          $scriptPath = Join-Path $env:GITHUB_WORKSPACE 'msvc-build.sh'
          $scriptContent = @'
          set -euxo pipefail

          WORKSPACE=$(cygpath "$GITHUB_WORKSPACE")
          cd "$WORKSPACE"

          curl -L "$FFMPEG_SOURCE_URL/archive/refs/tags/${FFMPEG_VERSION}.tar.gz" -o ffmpeg.tar.gz
          tar -xf ffmpeg.tar.gz
          SRC_DIR="FFmpeg-${FFMPEG_VERSION}"
          if [ ! -d "$SRC_DIR" ]; then
            SRC_DIR=$(tar -tf ffmpeg.tar.gz | head -1 | cut -d/ -f1)
          fi
          cd "$SRC_DIR"

          PREFIX="$WORKSPACE/build"
          rm -rf "$PREFIX"
          mkdir -p "$PREFIX"

          VCPKG_ROOT="$GITHUB_WORKSPACE/vcpkg"
          TRIPLET_STATIC="x64-windows-static"
          TRIPLET_DYNAMIC="x64-windows"

          INCLUDE_MSYS=$(cygpath -m "$VCPKG_ROOT/installed/$TRIPLET_STATIC/include")
          LIB_MSYS=$(cygpath -m "$VCPKG_ROOT/installed/$TRIPLET_STATIC/lib")
          LIB_POSIX=$(cygpath "$VCPKG_ROOT/installed/$TRIPLET_STATIC/lib")

          PKGCONF_DIR=$(cygpath "$VCPKG_ROOT/installed/$TRIPLET_DYNAMIC/tools/pkgconf")
          PKGCONF_BIN="$PKGCONF_DIR/pkgconf.exe"
          if [ ! -x "$PKGCONF_BIN" ]; then
            echo "pkgconf not found at $PKGCONF_BIN" >&2
            exit 1
          fi

          export PKG_CONFIG="$PKGCONF_BIN --msvc-syntax"
          export PKG_CONFIG_PATH=$(cygpath -m "$VCPKG_ROOT/installed/$TRIPLET_STATIC/lib/pkgconfig")
          export PKG_CONFIG_LIBDIR="$PKG_CONFIG_PATH"
          export PKG_CONFIG_SYSTEM_LIBRARY_PATH=$(cygpath -m "$VCPKG_ROOT/installed/$TRIPLET_STATIC/lib")
          export PKG_CONFIG_SYSTEM_INCLUDE_PATH=$(cygpath -m "$VCPKG_ROOT/installed/$TRIPLET_STATIC/include")
          export PATH="$PATH:$(cygpath "$VCPKG_ROOT/installed/$TRIPLET_DYNAMIC/bin"):$PKGCONF_DIR"

          echo "Resolved include dir: $INCLUDE_MSYS"
          echo "Resolved lib dir: $LIB_MSYS"

          ./configure \
            --toolchain=msvc \
            --arch=x86_64 \
            --target-os=win64 \
            --prefix="$PREFIX" \
            --enable-shared \
            --disable-static \
            --enable-demuxer=dash \
            --enable-muxer=dash \
            --enable-protocol=http \
            --enable-protocol=https \
            --enable-libxml2 \
            --enable-gpl \
            --enable-version3 \
            --enable-schannel \
            --enable-zlib \
            --enable-nonfree \
            --disable-doc \
            --disable-ffplay \
            --disable-ffprobe \
            --disable-ffmpeg \
            --extra-cflags="-I$INCLUDE_MSYS" \
            --extra-ldflags="-LIBPATH:$LIB_MSYS"

          # 注意：这里不再覆盖 AR，不再使用 msvc-ar.sh，避免生成 libav.obj 相关问题
          make -j"$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)"
          make install

          if [ -f "$LIB_POSIX/zlib.lib" ]; then
            cp "$LIB_POSIX/zlib.lib" "$PREFIX/lib/"
            cp "$LIB_POSIX/zlib.lib" "$PREFIX/lib/z.lib"
          fi

          PACKAGE_NAME="ffmpeg-${FFMPEG_VERSION}-${ARTIFACT_SUFFIX}.tar.gz"
          cd "$WORKSPACE"
          mkdir -p artifacts
          tar -czf "artifacts/$PACKAGE_NAME" -C build .
          '@

          # 去掉前导缩进写入文件
          $scriptContent = [regex]::Replace($scriptContent, '^\s*', '', [System.Text.RegularExpressions.RegexOptions]::Multiline)
          $scriptContent | Set-Content -Path $scriptPath -Encoding utf8NoBOM

          # 4. 写一个 cmd wrapper，先调用 vcvars64，再跑 bash 脚本
          $cmdWrapper = @"
          @echo off
          call "$vcvars"
          set "VCPKG_ROOT=%GITHUB_WORKSPACE%\vcpkg"
          set "VCPKG_TRIPLET_STATIC=x64-windows-static"
          set "INCLUDE=%INCLUDE%;%VCPKG_ROOT%\installed\%VCPKG_TRIPLET_STATIC%\include"
          set "LIB=%LIB%;%VCPKG_ROOT%\installed\%VCPKG_TRIPLET_STATIC%\lib"
          set "PKG_CONFIG_PATH=%VCPKG_ROOT%\installed\%VCPKG_TRIPLET_STATIC%\lib\pkgconfig"
          "$bash" --noprofile --norc "$scriptPath"
          "@
          $cmdWrapperPath = Join-Path $env:GITHUB_WORKSPACE 'msvc-wrapper.cmd'
          $cmdWrapper = [regex]::Replace($cmdWrapper, "^(          )", "", [System.Text.RegularExpressions.RegexOptions]::Multiline)
          $cmdWrapper | Set-Content -Path $cmdWrapperPath -Encoding ascii

          & cmd.exe /c "$cmdWrapperPath"

      # -------------------- 上传 artifacts --------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ env.FFMPEG_VERSION }}-${{ matrix.artifact_suffix }}
          path: artifacts/ffmpeg-${{ env.FFMPEG_VERSION }}-${{ matrix.artifact_suffix }}.tar.gz

  # ==================== 发布 Release ====================
  release:
    name: Publish release
    runs-on: ubuntu-latest
    needs: desktop
    permissions:
      contents: write
    if: >
      (github.event_name == 'workflow_dispatch' && inputs.publish-release) ||
      startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            TAG_NAME="ffmpeg-${FFMPEG_VERSION}"
          else
            TAG_NAME="${GITHUB_REF_NAME}"
          fi
          RELEASE_NAME="FFmpeg ${FFMPEG_VERSION}"
          echo "tag=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          draft: false
          prerelease: false
          files: release-artifacts/**/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}